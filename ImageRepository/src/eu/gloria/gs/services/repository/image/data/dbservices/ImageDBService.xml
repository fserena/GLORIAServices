<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="eu.gloria.gs.services.repository.image.data.dbservices.ImageDBService">

	<update id="create">
		CREATE TABLE IF NOT EXISTS `image`
		(
		`idimage` int(11) NOT NULL AUTO_INCREMENT,
		`rt` varchar(50) NOT NULL,
		`user` varchar(40) NOT NULL,
		`url` varchar(200) DEFAULT NULL,
		`date`
		datetime NOT NULL,
		`rid` int(11) DEFAULT NULL,
		`local_id` varchar(50)
		NOT NULL,
		`ccd` varchar(40) NOT NULL,
		PRIMARY KEY (`idimage`),
		KEY
		`fk_image_rt` (`rt`),
		KEY `fk_image_user` (`user`),
		KEY `fk_image_rid`
		(`rid`),
		KEY `fk_image_ccd` (`ccd`),
		CONSTRAINT `fk_image_rid` FOREIGN
		KEY (`rid`) REFERENCES `reservation`
		(`idreservation`) ON DELETE NO ACTION ON UPDATE NO ACTION,
		CONSTRAINT
		`fk_image_rt` FOREIGN KEY (`rt`) REFERENCES `rt`
		(`name`) ON DELETE
		CASCADE ON UPDATE CASCADE,
		CONSTRAINT `fk_image_user`
		FOREIGN KEY (`user`) REFERENCES `user` (`name`) ON
		DELETE NO ACTION ON UPDATE NO ACTION
		) ENGINE=InnoDB DEFAULT
		CHARSET=utf8
	</update>

	<select id="get"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		idimage=#{id_}
	</select>

	<select id="getByUser"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		user=#{user_}
	</select>

	<select id="getByUrl"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		url=#{url_}
	</select>

	<select id="getByRT"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		rt=#{rt_}
	</select>

	<select id="getByRTLocalId"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		rt=#{rt_} AND
		local_id=#{lid_}
	</select>

	<select id="getByReservation"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		rid=#{rid_}
	</select>

	<select id="getAllBetweenDates"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE date &gt;=
		#{from_}
		AND date &lt;=#{to_}
	</select>

	<insert id="save"
		parameterType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		INSERT INTO
		`image`
		(rt, user, date,
		local_id, ccd)
		VALUE ( #{rt}, #{user}, #{date}, #{local_id}, #{ccd})
	</insert>
	
	<delete id="remove">
		DELETE FROM `image`
		WHERE
		idimage=#{id_}
	</delete>

	<!-- <delete id="removeByUser">
		DELETE FROM `image`
		WHERE
		user=#{user_}
	</delete>-->

	<update id="setUser">
		UPDATE `image`
		SET
		user=#{user_}
		WHERE idimage
		=#{id_}
	</update>

	<update id="setReservation">
		UPDATE `image`
		SET
		rid=#{rid_}
		WHERE
		idimage
		=#{id_}
	</update>

	<update id="setUrl">
		UPDATE `image`
		SET
		url=#{url_}
		WHERE
		idimage
		=#{id_}
	</update>

	<update id="setUrlByRTLocalId">
		UPDATE `image`
		SET
		url=#{url_}
		WHERE
		rt=#{rt_} AND local_id=#{lid_}
	</update>

	<select id="contains" resultType="boolean">
		SELECT count(*)>0 FROM
		`image`
		WHERE
		idimage=#{id_}
	</select>

	<select id="containsUrl" resultType="boolean">
		SELECT count(*)>0 FROM
		`image`
		WHERE
		url=#{url_}
	</select>

	<select id="containsRTLocalId" resultType="boolean">
		SELECT count(*)>0 FROM
		`image`
		WHERE
		rt=#{rt_} AND local_id=#{lid_}
	</select>

	<select id="getAllWithoutUrl"
		resultType="eu.gloria.gs.services.repository.image.data.dbservices.ImageEntry">
		SELECT * FROM
		`image`
		WHERE
		url IS NULL
	</select>

</mapper>
